<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Shopee Affiliate Smart Filter - Max Commission</title>
    <style>
        :root { --shopee: #ee4d2d; --accent: #673ab7; --gold: #ffc107; }
        body { font-family: 'Segoe UI', sans-serif; background: #f8f9fa; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        
        .header { 
            background: linear-gradient(135deg, #ee4d2d, #ff7337); 
            color: white; padding: 25px; border-radius: 15px; 
            text-align: center; margin-bottom: 20px;
        }

        .config-panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        .drop-zone { 
            border: 2px dashed #ddd; padding: 30px; text-align: center; 
            border-radius: 10px; cursor: pointer; transition: 0.3s; margin-bottom: 15px;
        }
        .drop-zone:hover { border-color: var(--shopee); background: #fffaf9; }
        
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        .btn-group { display: flex; gap: 10px; }
        button { 
            flex: 1; padding: 15px; border: none; border-radius: 8px; 
            font-weight: bold; cursor: pointer; color: white; transition: 0.2s;
        }
        .btn-run { background: var(--accent); font-size: 16px; }
        .btn-run:hover { transform: scale(1.02); box-shadow: 0 5px 15px rgba(103, 58, 183, 0.3); }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-top: 25px; }
        .card { 
            background: white; border-radius: 12px; padding: 15px; position: relative;
            border-top: 6px solid #ccc; transition: 0.3s; display: flex; flex-direction: column;
        }
        .card.top-deal { border-top-color: var(--gold); background: #fffdf5; }
        
        .comm-badge { 
            position: absolute; top: 10px; right: 10px; 
            background: var(--shopee); color: white; padding: 5px 10px; 
            border-radius: 20px; font-weight: bold; font-size: 14px;
        }
        
        .price { color: var(--shopee); font-size: 1.4em; font-weight: bold; margin: 10px 0; }
        .time-info { font-size: 13px; color: #666; display: flex; align-items: center; gap: 5px; }
        
        .links { display: flex; gap: 8px; margin-top: auto; padding-top: 15px; }
        .links a { 
            flex: 1; text-align: center; padding: 12px; border-radius: 6px; 
            text-decoration: none; font-weight: bold; color: white; font-size: 13px;
        }
        .bg-shopee { background: var(--shopee); }
        .bg-blue { background: #007bff; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üöÄ Shopee Affiliate Super Filter</h1>
        <p>L·ªçc Ch·ªØ C√°i ‚Ä¢ H·∫°n > 3H ‚Ä¢ ∆Øu Ti√™n Hoa H·ªìng Cao</p>
    </div>

    <div class="config-panel">
        <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
            <b id="fileLabel">üìÅ Nh·∫•n ƒë·ªÉ ch·ªçn t·ªáp CSV t·ª´ m√°y t√≠nh</b>
            <input type="file" id="fileInput" accept=".csv" style="display:none">
        </div>

        <div class="input-row">
            <div>
                <label><b>K√Ω t·ª± t√¨m ki·∫øm (v√≠ d·ª•: N-I-√î):</b></label>
                <input type="text" id="chars" placeholder="Nh·∫≠p ch·ªØ c√°i...">
            </div>
            <div>
                <label><b>Tr·∫°ng th√°i:</b></label>
                <div id="status" style="padding: 12px; font-weight: bold; color: var(--accent);">Ch·ªù nh·∫≠p d·ªØ li·ªáu...</div>
            </div>
        </div>

        <textarea id="csvData" style="height: 80px; font-size: 11px;" placeholder="N·ªôi dung CSV..."></textarea>

        <div class="btn-group">
            <button class="btn-run" onclick="execute()">üî• L·ªåC & S·∫ÆP X·∫æP HOA H·ªíNG CAO NH·∫§T</button>
            <button style="background:#6c757d; flex:0.2;" onclick="location.reload()">X√≥a</button>
        </div>
    </div>

    <div class="grid" id="resultGrid"></div>
</div>

<script>
    // ƒê·ªçc File CSV
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('fileLabel').innerText = "‚úÖ ƒê√£ nh·∫≠n: " + file.name;
            const reader = new FileReader();
            reader.onload = (ev) => document.getElementById('csvData').value = ev.target.result;
            reader.readAsText(file);
        }
    });

    function normalize(s) {
        return s.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/ƒë/g, 'd').toLowerCase();
    }

    function execute() {
        const raw = document.getElementById('csvData').value.trim();
        const searchInput = normalize(document.getElementById('chars').value).replace(/[^a-z0-9]/g, '');
        const searchChars = searchInput.split('');
        
        if (searchChars.length < 3) { alert("Vui l√≤ng nh·∫≠p √≠t nh·∫•t 3 ch·ªØ c√°i!"); return; }

        const lines = raw.split('\n');
        const grid = document.getElementById('resultGrid');
        grid.innerHTML = '';
        
        let products = [];
        const regex = /(".*?"|[^",\s]+)(?=\s*,|\s*$)/g;

        for (let i = 1; i < lines.length; i++) {
            const m = lines[i].match(regex);
            if (!m || m.length < 8) continue;

            const rateStr = m[5].replace(/"/g, '').replace('%', '').trim();
            const rateVal = parseFloat(rateStr) || 0;
            const endTime = m[9] ? m[9].replace(/"/g, '') : "";
            const diffHours = endTime ? (new Date(endTime) - new Date()) / (1000 * 60 * 60) : 999;

            // L·ªçc 1: Th·ªùi gian ph·∫£i > 3h
            if (diffHours <= 3) continue;

            // L·ªçc 2: Tr√πng √≠t nh·∫•t 3 ch·ªØ c√°i ho√°n v·ªã
            const name = m[1].replace(/"/g, '');
            const shop = m[4].replace(/"/g, '');
            const targetText = normalize(name + shop);
            
            let matchCount = 0;
            let tempTarget = targetText;
            searchChars.forEach(c => {
                if (tempTarget.includes(c)) {
                    matchCount++;
                    tempTarget = tempTarget.replace(c, '');
                }
            });

            if (matchCount >= 3) {
                products.push({
                    name, shop, rate: rateVal, 
                    price: m[2].replace(/"/g, ''),
                    link: m[7].replace(/"/g, ''),
                    promo: m[8] ? m[8].replace(/"/g, '') : m[7].replace(/"/g, ''),
                    hours: diffHours
                });
            }
        }

        // S·∫ÆP X·∫æP: Hoa h·ªìng cao nh·∫•t l√™n ƒë·∫ßu
        products.sort((a, b) => b.rate - a.rate);

        products.forEach((p, idx) => {
            const card = document.createElement('div');
            card.className = `card ${idx < 3 ? 'top-deal' : ''}`; // Highlight 3 c√°i cao nh·∫•t
            card.innerHTML = `
                <div class="comm-badge">${p.rate}%</div>
                <div style="font-weight:bold; font-size:14px; margin-top:20px; height:40px; overflow:hidden;">${p.name}</div>
                <div class="price">${p.price}</div>
                <div class="time-info">
                    <span>üè™ ${p.shop}</span> ‚Ä¢ 
                    <span style="color:${p.hours < 10 ? 'red' : 'green'}">‚è≥ C√≤n ~${Math.floor(p.hours)}h</span>
                </div>
                <div class="links">
                    <a href="${p.link}" target="_blank" class="bg-blue">Link G·ªëc</a>
                    <a href="${p.promo}" target="_blank" class="bg-shopee">L·∫§Y LINK AFF</a>
                </div>
            `;
            grid.appendChild(card);
        });

        document.getElementById('status').innerText = `ƒê√£ t√¨m th·∫•y ${products.length} s·∫£n ph·∫©m ∆∞u ƒë√£i nh·∫•t!`;
    }
</script>

</body>
</html>