<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Hệ Thống Affiliate Kim Tứ Đồ Hub - PRO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --color-L: #dc3545; --color-T: #007bff; --color-C: #6f42c1; --color-D: #ffc107; 
            --shopee-orange: #ff5722; --bg: #f0f2f5;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: auto; }
        .header { background: linear-gradient(135deg, #2c3e50, #000); color: white; padding: 30px; border-radius: 20px; text-align: center; margin-bottom: 25px; }

        .quadrant-menu { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .q-btn { padding: 20px; border: none; border-radius: 15px; color: white; font-weight: bold; cursor: pointer; transition: 0.4s; text-align: center; }
        .q-btn.active { transform: scale(1.05); box-shadow: 0 8px 25px rgba(0,0,0,0.2); border: 2px solid white; }
        
        .btn-L { background: var(--color-L); } .btn-T { background: var(--color-T); }
        .btn-C { background: var(--color-C); } .btn-D { background: var(--color-D); color: #000; }

        .main-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }

        textarea, input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-action { background: var(--shopee-orange); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; }

        /* Kết quả hiển thị */
        #resultGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .product-card { background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px; border-top: 5px solid #ccc; }
        .img-preview { width: 100%; aspect-ratio: 1/1; background: #f9f9f9; border-radius: 8px; object-fit: cover; margin-bottom: 10px; border: 1px solid #eee; }
        .price { color: #ee4d2d; font-size: 18px; font-weight: bold; margin: 5px 0; }
        
        /* Panel xuất JSON */
        #exportZone { display: none; background: #eef2f7; padding: 15px; border-radius: 10px; margin-top: 20px; }
        .json-box { background: #2c3e50; color: #2ecc71; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 11px; overflow-x: auto; white-space: pre-wrap; max-height: 200px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-gem"></i> KIM TỨ ĐỒ AFFILIATE PRO</h1>
        <p id="target-desc">L (Ngày): Tập trung số lượng đơn cực lớn.</p>
    </div>

    <div class="quadrant-menu">
        <div class="q-btn btn-L active" onclick="setQuadrant('L')"><span>L</span><small>Dưới 200k</small></div>
        <div class="q-btn btn-T" onclick="setQuadrant('T')"><span>T</span><small>200k - 1tr</small></div>
        <div class="q-btn btn-C" onclick="setQuadrant('C')"><span>C</span><small>1tr - 5tr</small></div>
        <div class="q-btn btn-D" onclick="setQuadrant('D')"><span>Đ</span><small>Trên 5tr</small></div>
    </div>

    <div class="main-grid">
        <div class="left-col">
            <div class="card">
                <h3><i class="fas fa-file-import"></i> 1. Nhập CSV & Mục Tiêu</h3>
                <textarea id="csvData" rows="6" placeholder="Dán cột: Tên, Link, Số bán, Giá, Hoa hồng..."></textarea>
                <input type="number" id="targetMoney" placeholder="Mục tiêu thu nhập (VNĐ)">
                <button class="btn-action" onclick="executeAnalysis()">PHÂN TÍCH & LỌC HÀNG</button>
            </div>

            <div class="card" id="exportZone">
                <h3><i class="fas fa-box-open"></i> 3. KHO HÀNG CHỜ XUẤT</h3>
                <div id="jsonContent" class="json-box">[]</div>
                <button class="btn-action" style="background:#2ecc71; margin-top:10px;" onclick="copyJson()">COPY MÃ NÀY DÁN VÀO FILE 001</button>
                <button onclick="clearQueue()" style="background:none; border:none; color:red; cursor:pointer; font-size:12px; margin-top:10px;">Xóa danh sách chờ</button>
            </div>
        </div>

        <div class="right-col">
            <div class="card">
                <h3><i class="fas fa-search-dollar"></i> 2. Chọn Siêu Phẩm Vào Kho</h3>
                <div id="resultGrid"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentQ = 'L';
    let queueItems = []; // Kho hàng tạm thời
    const configs = {
        'L': { minP: 0, maxP: 200000, money: 100000, desc: "Hàng dưới 200k. Dễ chốt đơn, phủ rộng." },
        'T': { minP: 200001, maxP: 1000000, money: 1000000, desc: "Hàng 200k - 1tr. Thu nhập khá." },
        'C': { minP: 1000001, maxP: 5000000, money: 5000000, desc: "Hàng 1tr - 5tr. Xây dựng thương hiệu." },
        'D': { minP: 5000001, maxP: 999999999, money: 20000000, desc: "Hàng trên 5tr. Săn cá voi." }
    };

    function setQuadrant(q) {
        currentQ = q;
        document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('.btn-' + q).classList.add('active');
        document.getElementById('targetMoney').value = configs[q].money;
        document.getElementById('target-desc').innerText = configs[q].desc;
        executeAnalysis();
    }

    function executeAnalysis() {
        const raw = document.getElementById('csvData').value.trim();
        const grid = document.getElementById('resultGrid');
        grid.innerHTML = '';
        if(!raw) return;

        const lines = raw.split('\n');
        lines.forEach((line, index) => {
            // Regex xử lý CSV phức tạp
            const m = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if (!m || m.length < 4) return;

            const name = m[0].replace(/"/g, '');
            const link = m[1].replace(/"/g, '');
            const price = parseFloat(m[3].replace(/[",.]/g, '')) || 0;

            if (price >= configs[currentQ].minP && price <= configs[currentQ].maxP) {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.style.borderTopColor = `var(--color-${currentQ})`;
                card.innerHTML = `
                    <img id="img_prev_${index}" class="img-preview" src="https://via.placeholder.com/150?text=Chưa+có+ảnh">
                    <div style="font-size:12px; font-weight:bold; height:35px; overflow:hidden;">${name}</div>
                    <div class="price">${price.toLocaleString()}đ</div>
                    <input type="text" id="img_url_${index}" oninput="updatePreview(${index})" placeholder="Dán link ảnh từ Shopee...">
                    <button class="btn-action" style="padding:8px; font-size:12px;" onclick="addToQueue('${name}', '${price.toLocaleString()}đ', '${link}', ${index})">LƯU VÀO KHO TỔNG</button>
                `;
                grid.appendChild(card);
            }
        });
    }

    function updatePreview(index) {
        const url = document.getElementById(`img_url_${index}`).value;
        if(url) document.getElementById(`img_prev_${index}`).src = url;
    }

    function addToQueue(name, price, link, index) {
        const img = document.getElementById(`img_url_${index}`).value;
        if(!img) { alert("Vui lòng dán link ảnh sản phẩm trước!"); return; }

        const newItem = {
            name: name,
            price: price,
            link: link, // Đây là link affiliate lấy từ CSV
            img: img,
            desc: "Ưu đãi đặc biệt từ Nam Nguyễn Affiliate"
        };

        queueItems.push(newItem);
        document.getElementById('exportZone').style.display = 'block';
        document.getElementById('jsonContent').innerText = JSON.stringify(queueItems, null, 2);
        alert("Đã thêm thành công vào danh sách chờ!");
    }

    function copyJson() {
        const content = document.getElementById('jsonContent').innerText;
        navigator.clipboard.writeText(content);
        alert("Đã copy mã! Bây giờ hãy mở file 001-kho-hang.html?admin=true và dán vào ô Nhập Kho.");
    }

    function clearQueue() {
        queueItems = [];
        document.getElementById('jsonContent').innerText = "[]";
        document.getElementById('exportZone').style.display = 'none';
    }
</script>
</body>
</html>
