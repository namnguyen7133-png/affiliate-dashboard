<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Affiliate Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family:Arial,sans-serif;
  background:#f4f6fa;
  max-width:1000px;
  margin:auto;
  padding:15px;
}
h1{text-align:center;color:#0b4f6c}
.card{
  background:#fff;
  padding:15px;
  border-radius:12px;
  margin:15px 0;
}
.tabs button{
  padding:8px 12px;
  margin-right:5px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.tabs .active{background:#0b4f6c;color:#fff}
button.export{
  background:#2e7d32;
  color:#fff;
  padding:8px 12px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
canvas{max-width:100%}
</style>
</head>

<body>

<h1>ğŸ“Š AFFILIATE DASHBOARD</h1>

<div class="tabs">
  <button onclick="setPlatform('all')" class="active">ğŸŒ Táº¥t cáº£</button>
  <button onclick="setPlatform('shopee')">ğŸ›’ Shopee</button>
  <button onclick="setPlatform('facebook')">ğŸ“˜ Facebook</button>
  <button onclick="setPlatform('zalo')">ğŸ’¬ Zalo</button>
</div>

<div class="card">
  <h3>ğŸ’° Hoa há»“ng theo ngÃ y</h3>
  <canvas id="chartDay" height="120"></canvas>
</div>

<div class="card">
  <h3>ğŸ—“ï¸ Hoa há»“ng theo thÃ¡ng</h3>
  <canvas id="chartMonth" height="120"></canvas>
</div>

<div class="card">
  <button class="export" onclick="exportCSV()">ğŸ“¤ Xuáº¥t bÃ¡o cÃ¡o CSV</button>
</div>

<script>
let currentPlatform="all";
let rawData=[];
let chartDay, chartMonth;

function setPlatform(p){
  currentPlatform=p;
  document.querySelectorAll(".tabs button")
    .forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");
  renderCharts();
}

fetch("data/hoa-hong.csv")
  .then(r=>r.text())
  .then(t=>{
    rawData=t.trim().split("\n").slice(1).map(r=>{
      const [date,commission,platform,link]=r.split(",");
      return {date,commission:Number(commission),platform,link};
    });
    renderCharts();
  });

function renderCharts(){
  const data=currentPlatform==="all"
    ? rawData
    : rawData.filter(r=>r.platform===currentPlatform);

  const dayMap={}, monthMap={};

  data.forEach(r=>{
    dayMap[r.date]=(dayMap[r.date]||0)+r.commission;
    const m=r.date.slice(0,7);
    monthMap[m]=(monthMap[m]||0)+r.commission;
  });

  renderChart(
    "chartDay",
    "Hoa há»“ng theo ngÃ y",
    dayMap,
    "date",
    data,
    chartDay,
    c=>chartDay=c
  );

  renderChart(
    "chartMonth",
    "Hoa há»“ng theo thÃ¡ng",
    monthMap,
    "month",
    data,
    chartMonth,
    c=>chartMonth=c
  );
}

function renderChart(id,label,map,mode,data,oldChart,setChart){
  if(oldChart) oldChart.destroy();

  const labels=Object.keys(map);
  const values=Object.values(map);
  const max=Math.max(...values);

  const colors=values.map(v=>v===max?"#d32f2f":"#1976d2");

  const chart=new Chart(document.getElementById(id),{
    type:"bar",
    data:{
      labels:labels,
      datasets:[{
        label:label,
        data:values,
        backgroundColor:colors
      }]
    },
    options:{
      onClick:(e,els)=>{
        if(!els.length) return;
        const key=labels[els[0].index];
        const item=data.find(r=>
          mode==="date"?r.date===key:r.date.startsWith(key)
        );
        if(item?.link) window.open(item.link,"_blank");
      },
      plugins:{
        tooltip:{
          callbacks:{
            label:c=>c.raw.toLocaleString("vi-VN")+" â‚«"
          }
        }
      },
      scales:{
        y:{ticks:{callback:v=>v.toLocaleString("vi-VN")+" â‚«"}}
      }
    }
  });

  setChart(chart);
}

function exportCSV(){
  const data=currentPlatform==="all"
    ? rawData
    : rawData.filter(r=>r.platform===currentPlatform);

  let csv="date,commission,platform\n";
  data.forEach(r=>{
    csv+=`${r.date},${r.commission},${r.platform}\n`;
  });

  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="bao-cao-hoa-hong.csv";
  a.click();
}
</script>

</body>
</html>
