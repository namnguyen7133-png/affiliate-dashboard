<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Affiliate Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family:Arial,sans-serif;
  background:#f4f6fa;
  max-width:1100px;
  margin:auto;
  padding:15px;
}
h1{text-align:center;color:#0b4f6c}
.card{
  background:#fff;
  padding:15px;
  border-radius:12px;
  margin:15px 0;
}
.tabs button{
  padding:8px 12px;
  margin-right:5px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.tabs .active{background:#0b4f6c;color:#fff}
button.export{
  background:#2e7d32;
  color:#fff;
  padding:8px 12px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
textarea{width:100%;min-height:70px}
canvas{max-width:100%}
.bad{color:#d32f2f}
.ok{color:#f57c00}
.good{color:#2e7d32}
</style>
</head>

<body>

<h1>ğŸ“Š AFFILIATE DASHBOARD</h1>

<div class="card" id="suggestBox">
  <h3>ğŸ¤– Gá»£i Ã½ hÃ´m nay</h3>
  <div id="suggestContent">Äang phÃ¢n tÃ­ch dá»¯ liá»‡uâ€¦</div>
</div>

<div class="tabs">
  <button onclick="setPlatform('all')" class="active">ğŸŒ Táº¥t cáº£</button>
  <button onclick="setPlatform('shopee')">ğŸ›’ Shopee</button>
  <button onclick="setPlatform('facebook')">ğŸ“˜ Facebook</button>
  <button onclick="setPlatform('zalo')">ğŸ’¬ Zalo</button>
</div>

<div class="card">
  <h3>ğŸ’° Hoa há»“ng theo ngÃ y</h3>
  <canvas id="chartDay" height="120"></canvas>
</div>

<div class="card">
  <h3>ğŸ—“ï¸ Hoa há»“ng theo thÃ¡ng</h3>
  <canvas id="chartMonth" height="120"></canvas>
</div>

<div class="card">
  <h3>ğŸ“… Lá»‹ch Ä‘Äƒng 7 ngÃ y</h3>
  <div id="schedule"></div>
</div>

<div class="card">
  <button class="export" onclick="exportCSV()">ğŸ“¤ Xuáº¥t bÃ¡o cÃ¡o CSV</button>
</div>

<script>
let rawData=[];
let currentPlatform="all";
let chartDay, chartMonth;

/* ===== GIá»œ ÄÄ‚NG ===== */
function bestPostTime(p){
  return {
    facebook:["07:30","12:00","20:00"],
    zalo:["07:00","20:30"],
    shopee:["10:00","15:00","21:00"]
  }[p]||["08:00"];
}

/* ===== AI CAPTION ===== */
function caption(platform,category,link){
  const map={
    "gia-dung":"ğŸ  Äá»“ gia dá»¥ng nhÃ  mÃ¬nh Ä‘ang dÃ¹ng tháº¥y ráº¥t tiá»‡n",
    "lam-dep":"âœ¨ DÃ¹ng thá»­ rá»“i tháº¥y á»•n nÃªn chia sáº»",
    "me-be":"ğŸ‘¶ Máº¹ bá»‰m nÃªn tham kháº£o mÃ³n nÃ y",
    "cong-nghe":"ğŸ“± MÃ³n cÃ´ng nghá»‡ nÃ y Ä‘ang Ä‘Æ°á»£c quan tÃ¢m"
  };
  return `${map[category]||"Sáº£n pháº©m Ä‘ang bÃ¡n tá»‘t"}\nğŸ‘‰ Xem chi tiáº¿t: ${link}`;
}

/* ===== LOAD DATA ===== */
fetch("data/hoa-hong.csv")
.then(r=>r.text())
.then(t=>{
  rawData=t.trim().split("\n").slice(1).map(r=>{
    const [date,commission,platform,link,category]=r.split(",");
    return {date,commission:+commission,platform,link,category};
  });
  renderAll();
});

/* ===== RENDER ===== */
function setPlatform(p){
  currentPlatform=p;
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");
  renderAll();
}

function renderAll(){
  const data=currentPlatform==="all"
    ? rawData
    : rawData.filter(r=>r.platform===currentPlatform);

  renderCharts(data);
  suggest(data);
  renderSchedule(data);
}

/* ===== BIá»‚U Äá»’ ===== */
function renderCharts(data){
  const day={},month={};

  data.forEach(r=>{
    day[r.date]=(day[r.date]||0)+r.commission;
    month[r.date.slice(0,7)]=(month[r.date.slice(0,7)]||0)+r.commission;
  });

  draw("chartDay",day,"Hoa há»“ng ngÃ y",c=>chartDay=c,chartDay);
  draw("chartMonth",month,"Hoa há»“ng thÃ¡ng",c=>chartMonth=c,chartMonth);
}

function draw(id,map,label,set,old){
  if(old) old.destroy();
  const chart=new Chart(document.getElementById(id),{
    type:"bar",
    data:{labels:Object.keys(map),datasets:[{label,data:Object.values(map)}]},
    options:{scales:{y:{ticks:{callback:v=>v.toLocaleString()+" â‚«"}}}}
  });
  set(chart);
}

/* ===== Gá»¢I Ã ===== */
function suggest(data){
  const box=document.getElementById("suggestContent");
  if(!data.length){box.innerText="ChÆ°a cÃ³ dá»¯ liá»‡u";return;}

  const m={};
  data.forEach(r=>{
    if(!m[r.link]) m[r.link]={sum:0,platform:r.platform,category:r.category};
    m[r.link].sum+=r.commission;
  });

  const top=Object.entries(m).sort((a,b)=>b[1].sum-a[1].sum).slice(0,3);

  let html="<b>ğŸ”¥ TOP 3 LINK NÃŠN ÄÄ‚NG</b><hr>";
  top.forEach(([link,i],idx)=>{
    const score=i.sum>50000?"A":i.sum>20000?"B":"C";
    html+=`
    <b>#${idx+1} â€“ Äiá»ƒm ${score}</b><br>
    ğŸ’° ${i.sum.toLocaleString()} â‚«<br>
    â° ${bestPostTime(i.platform).join(", ")}<br>
    <textarea>${caption(i.platform,i.category,link)}</textarea>
    <hr>`;
  });
  box.innerHTML=html;
}

/* ===== Lá»ŠCH 7 NGÃ€Y ===== */
function renderSchedule(data){
  const box=document.getElementById("schedule");
  let html="";
  for(let i=0;i<7;i++){
    const d=new Date();
    d.setDate(d.getDate()+i);
    html+=`ğŸ“… ${d.toISOString().slice(0,10)} â€“ ÄÄƒng bÃ i lÃºc 20:00<br>`;
  }
  box.innerHTML=html;
}

/* ===== EXPORT ===== */
function exportCSV(){
  let csv="date,commission,platform,link,category\n";
  rawData.forEach(r=>csv+=`${r.date},${r.commission},${r.platform},${r.link},${r.category}\n`);
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="bao-cao-affiliate.csv";
  a.click();
}
</script>

</body>
</html>
