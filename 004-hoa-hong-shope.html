<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Ph√¢n T√≠ch Affiliate & ƒê·ªãnh L∆∞·ª£ng CSV</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); }
        h2 { color: #ee4d2d; text-align: center; border-bottom: 3px solid #ee4d2d; padding-bottom: 10px; margin-bottom: 30px; }
        .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .section { padding: 20px; border: 1px solid #e0e0e0; border-radius: 10px; background: #fafafa; }
        label { font-weight: bold; display: block; margin-bottom: 8px; color: #444; }
        textarea { width: 100%; height: 120px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        input[type="text"], input[type="number"], input[type="file"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        button { padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-filter { background-color: #ee4d2d; color: white; width: 100%; margin-top: 10px; font-size: 16px; }
        .btn-sample { background-color: #2e7d32; color: white; }
        .btn-reset { background-color: #757575; color: white; }
        .btn-save-hub { background-color: #ff9800; color: white; margin-top: 10px; padding: 8px 15px; font-size: 12px; }
        button:hover { opacity: 0.9; transform: translateY(-2px); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 25px; }
        th { background: #ee4d2d; color: white; padding: 12px; font-size: 14px; text-align: left; }
        td { border-bottom: 1px solid #eee; padding: 15px; vertical-align: top; font-size: 14px; line-height: 1.6; }
        .stt { font-weight: bold; color: #ee4d2d; width: 30px; }
        .stats-info { font-size: 11px; color: #777; background: #f0f0f0; padding: 8px; border-radius: 5px; margin-top: 10px; }
        .highlight-char { background-color: #ffeb3b; color: #d32f2f; font-weight: bold; padding: 0 2px; border: 1px solid #fbc02d; }
        .link-btn { display: inline-block; margin-top: 10px; margin-right: 10px; padding: 6px 15px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Tr√¨nh Ph√¢n T√≠ch & L·ªçc CSV Chuy√™n S√¢u</h2>

    <div class="grid-layout">
        <div class="section">
            <label>Ngu·ªìn 1: Nh·∫≠p t·ªáp CSV t·ª´ m√°y t√≠nh</label>
            <input type="file" id="csvFile" accept=".csv">
            <p style="font-size: 11px; color: blue;">* ∆Øu ti√™n d√πng t·ªáp CSV n·∫øu c√≥ l∆∞·ª£ng d·ªØ li·ªáu l·ªõn.</p>
            
            <label style="margin-top: 15px;">Ngu·ªìn 2: D√°n vƒÉn b·∫£n tr·ª±c ti·∫øp</label>
            <textarea id="inputText" placeholder="D√°n n·ªôi dung t·∫°i ƒë√¢y n·∫øu kh√¥ng d√πng file..."></textarea>
        </div>

        <div class="section">
            <label>Ti√™u ch√≠ 1: 3 ch·ªØ c√°i cu·ªëi (c√°ch nhau d·∫•u ph·∫©y)</label>
            <input type="text" id="targetChars" placeholder="N, √î, N">
            
            <label style="margin-top: 15px;">Ti√™u ch√≠ 2: M·ª•c ti√™u k√Ω t·ª± (¬±10%)</label>
            <input type="number" id="targetCount" placeholder="V√≠ d·ª•: 232">
            
            <div class="btn-group">
                <button class="btn-sample" onclick="setSample()">M·∫´u: N,√î,N & 232 k√Ω t·ª±</button>
                <button class="btn-reset" onclick="resetAll()">L√†m m·ªõi</button>
            </div>
        </div>
    </div>

    <button class="btn-filter" onclick="handleProcess()">B·∫ÆT ƒê·∫¶U PH√ÇN T√çCH D·ªÆ LI·ªÜU</button>

    <div id="summary" style="margin: 20px 0; font-weight: bold; color: #2e7d32; text-align: center;"></div>
    <div id="resultArea"></div>
</div>

<script>
    // --- H√ÄM C·∫¶U N·ªêI L∆ØU D·ªÆ LI·ªÜU ---
    function saveToGlobalHub(name, link, charCount) {
        const STORAGE_KEY = 'nam_affiliate_hub_storage';
        let hubData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        
        const newProduct = {
            name: name,
            link: link,
            price: "L·ªçc t·ª´ CSV",
            tier: "L", // M·∫∑c ƒë·ªãnh t·∫ßng L (H√†ng ng√†y) cho s·∫£n ph·∫©m l·ªçc
            platform: "Shopee",
            note: "K√Ω t·ª±: " + charCount,
            dateSaved: new Date().toLocaleDateString()
        };

        if (hubData.some(item => item.link === link)) {
            alert("S·∫£n ph·∫©m n√†y ƒë√£ t·ªìn t·∫°i trong Kho T·ªïng!");
            return;
        }

        hubData.push(newProduct);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(hubData));
        alert("üöÄ ƒê√£ ƒë·∫©y v√†o Kho T·ªïng th√†nh c√¥ng!");
    }

    // --- LOGIC X·ª¨ L√ù CSV C·ª¶A B·∫†N ---
    function setSample() {
        document.getElementById('targetChars').value = "N, √î, N";
        document.getElementById('targetCount').value = 232;
    }

    function resetAll() { location.reload(); }

    async function handleProcess() {
        const fileInput = document.getElementById('csvFile');
        const textInput = document.getElementById('inputText').value;
        let contentToProcess = "";
        if (fileInput.files.length > 0) {
            contentToProcess = await fileInput.files[0].text();
        } else {
            contentToProcess = textInput;
        }
        if (!contentToProcess.trim()) {
            alert("Vui l√≤ng nh·∫≠p t·ªáp CSV ho·∫∑c d√°n vƒÉn b·∫£n!");
            return;
        }
        processData(contentToProcess);
    }

    function processData(fullText) {
        const targetInput = document.getElementById('targetChars').value;
        const targetCountVal = parseFloat(document.getElementById('targetCount').value);
        const resultArea = document.getElementById('resultArea');
        const summary = document.getElementById('summary');
        const targets = targetInput.split(',').map(s => s.trim().toUpperCase()).filter(s => s !== "");
        const lines = fullText.split(/\n(?=.*‚Ç´|.*ƒê√£ b√°n|.*ƒê√°nh gi√°)/g);
        
        let htmlTable = `<table><thead><tr><th>STT</th><th>N·ªôi dung & Thao t√°c</th></tr></thead><tbody>`;
        let count = 0;

        lines.forEach((line) => {
            const cleanLine = line.trim();
            if (!cleanLine) return;

            const charWithSpace = cleanLine.length;
            const wordCount = cleanLine.split(/\s+/).filter(s => s !== "").length;

            let passLimit = true;
            if (!isNaN(targetCountVal)) {
                const range = targetCountVal * 0.1;
                if (charWithSpace < (targetCountVal - range) || charWithSpace > (targetCountVal + range)) passLimit = false;
            }

            const words = cleanLine.split(/\s+/);
            let matchCount = 0;
            let currentTargets = [...targets];
            let matchedIndices = [];

            words.forEach((word, idx) => {
                const cleanWord = word.replace(/[.,!?;:()"]+$/, "");
                const last = cleanWord.charAt(cleanWord.length - 1).toUpperCase();
                const tIdx = currentTargets.indexOf(last);
                if (tIdx !== -1) {
                    matchCount++;
                    currentTargets.splice(tIdx, 1);
                    matchedIndices.push(idx);
                }
            });

            if (matchCount >= 3 && passLimit) {
                count++;
                // Tr√≠ch xu·∫•t link ƒë·ªÉ l∆∞u
                const urlMatch = cleanLine.match(/https?:\/\/[^\s]+/);
                const firstLink = urlMatch ? urlMatch[0] : "#";
                const shortName = cleanLine.substring(0, 60).replace(/[^\w\s√†-·ªπ√Ä-·ª∏]/gi, '') + "...";

                const highlightedText = words.map((word, idx) => {
                    if (matchedIndices.includes(idx)) {
                        const cleanWord = word.replace(/[.,!?;:()"]+$/, "");
                        const punct = word.slice(cleanWord.length);
                        return `${cleanWord.slice(0, -1)}<span class="highlight-char">${cleanWord.slice(-1)}</span>${punct}`;
                    }
                    return word;
                }).join(' ');

                const lineWithLink = highlightedText.replace(/(https?:\/\/[^\s]+)/g, 
                    `<br><a href="$1" target="_blank" class="link-btn">Truy c·∫≠p Link üîó</a>`);

                htmlTable += `<tr>
                    <td class="stt">${count}</td>
                    <td>
                        <div>${lineWithLink}</div>
                        <button class="btn-save-hub" onclick="saveToGlobalHub('${shortName}', '${firstLink}', ${charWithSpace})">
                            üì• L∆∞u v√†o Kho T·ªïng
                        </button>
                        <div class="stats-info">üìä <b>K√Ω t·ª±:</b> ${charWithSpace} | <b>T·ª´:</b> ${wordCount}</div>
                    </td>
                </tr>`;
            }
        });

        htmlTable += `</tbody></table>`;
        summary.innerHTML = count > 0 ? `üéØ ƒê√£ t√¨m th·∫•y ${count} d√≤ng kh·ªõp ti√™u ch√≠!` : "Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£.";
        resultArea.innerHTML = count > 0 ? htmlTable : "";
    }
</script>
</body>
</html>
